WITH ranked AS (
    SELECT c.name AS customer_name, p.category, SUM(s.quantity * p.price) AS total_revenue
    FROM sales s JOIN products p ON p.product_id = s.product_id JOIN customers c ON c.customer_id = s.customer_id
    GROUP BY c.customer_id, c.name, p.category
)
SELECT
    category,
    customer_name,
    total_revenue
FROM ranked
ORDER BY category, total_revenue DESC